<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>筹备会议行动清单</title>

  <!-- ✅ 正确的 html2pdf.js CDN（用于导出 PDF） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- ✅ 正确的 QRCode.js CDN（关键修复） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style id="pageStyle">
    /* ===== 动态波浪背景 ===== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(45deg, #f0f7ff, #e6f3f9);
      background-attachment: fixed;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("image/svg+xml,%3Csvg width='42' height='42' viewBox='0 0 42 42' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%235dade2' fill-opacity='0.05'%3E%3Cpath d='M21 0c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 26c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 13c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0-26c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0 26c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5z'%2F%3E%3C/g%3E%3C/svg%3E");
      background-size: 42px 42px;
      animation: pan 20s linear infinite;
      z-index: -1;
      opacity: 0.6;
    }

    @keyframes pan {
      0% { transform: translate(0, 0); }
      100% { transform: translate(42px, 42px); }
    }

    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 30px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 32px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn-select { background-color: #3498db; color: white; }
    .btn-print { background-color: #2ecc71; color: white; }
    .btn-export { background-color: #9b59b6; color: white; }
    .btn-qrcode { background-color: #f39c12; color: white; }
    .btn-theme { background-color: #7f8c8d; color: white; }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      padding: 18px 24px;
      margin: 14px 0;
      border-radius: 8px;
      border: 1px solid #dde4e9;
      display: flex;
      align-items: flex-start;
      transition: all 0.3s ease;
      cursor: pointer;
      background-color: #fdfefe;
    }

    li:hover {
      border-color: #a0d2f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    li.completed {
      background-color: #e8f8f1;
      border-color: #b8e6d9;
      color: #777;
    }

    li.completed span.task-text {
      text-decoration: line-through;
      color: #888;
    }

    .task-checkbox {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .checkmark {
      display: inline-flex;
      width: 22px;
      height: 22px;
      background-color: #eee;
      border: 2px solid #ccc;
      border-radius: 6px;
      margin-right: 14px;
      flex-shrink: 0;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      margin-top: 5px;
    }

    .task-checkbox:checked + .checkmark {
      background-color: #2ecc71;
      border-color: #27ae60;
    }

    .task-checkbox:checked + .checkmark::after {
      content: '✓';
      display: block;
      color: white;
      font-size: 18px;
    }

    .task-checkbox + .checkmark::after {
      content: '';
    }

    .task-text {
      font-size: 18px;
      flex: 1;
      cursor: pointer;
      user-select: none;
    }

    .summary {
      text-align: center;
      margin-top: 30px;
      font-size: 20px;
      font-weight: bold;
      color: #2c3e50;
      padding: 16px;
      background-color: #f5f9fc;
      border-radius: 8px;
      border: 1px solid #d0e7f4;
    }

    /* ============ 夜间模式样式 ============ */
    body.night {
      background: #121212;
      color: #e0e0e0;
    }

    body.night::before {
      opacity: 0.2;
    }

    body.night .container {
      background-color: #1e1e1e;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    body.night h1,
    body.night .summary,
    body.night li {
      color: #e0e0e0;
    }

    body.night li {
      background-color: #2a2a2a;
      border-color: #444;
    }

    body.night li.completed {
      background-color: #1a362c;
      border-color: #2c5c49;
    }

    body.night .summary {
      background-color: #2d2d2d;
      border-color: #444;
    }

    body.night .checkmark {
      background-color: #333;
      border-color: #555;
    }

    body.night .task-checkbox:checked + .checkmark {
      background-color: #27ae60;
    }
  </style>
</head>
<body>

  <!-- 二维码弹窗 -->
  <div id="qrcodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
      <h3>📱 扫码在手机查看</h3>
      <div id="qrcode"></div>
      <button onclick="closeQrCode()" style="margin-top: 15px; padding: 8px 16px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">关闭</button>
    </div>
  </div>

  <div class="container" id="exportArea">
    <h1>筹备会议行动清单</h1>

    <div class="controls">
      <button id="toggleAll">🔄 全选 / 取消全选</button>
      <button onclick="window.print()">🖨️ 打印清单</button>
      <button id="exportPdf">📥 导出为 PDF</button>
      <button id="showQrCode" class="btn-qrcode">📱 生成二维码</button>
      <button id="themeToggle" class="btn-theme">🌙 夜间模式</button>
    </div>

    <ul id="taskList">
      <!-- 任务由 JS 生成 -->
    </ul>

    <div class="summary" id="summary">
      已完成 0 / 5 项
    </div>
  </div>

  <script>
    const tasks = [
      "准备会前播放视频。",
      "按照中心统一格式模版制作、打印会议议程（参会领导、参会人员、工作人员每人1份）、签到表（1份），发放到位。",
      "打印参会人员通讯录2份。",
      "连接会议须用电脑、音频设备进行PPT、音频试放。",
      "准备话筒若干；会前30分钟播放中心视频，按照会议议程安排播放PPT、音频。"
    ];

    const taskList = document.getElementById('taskList');
    const summary = document.getElementById('summary');
    const toggleAllBtn = document.getElementById('toggleAll');
    const exportPdfBtn = document.getElementById('exportPdf');
    const showQrCodeBtn = document.getElementById('showQrCode');
    const themeToggleBtn = document.getElementById('themeToggle');
    const qrcodeModal = document.getElementById('qrcodeModal');

    let completedStatus = JSON.parse(localStorage.getItem('taskCompleted')) || tasks.map(() => false);

    function updateSummary() {
      const completed = completedStatus.filter(status => status).length;
      summary.textContent = `已完成 ${completed} / ${tasks.length} 项`;
    }

    tasks.forEach((task, index) => {
      const li = document.createElement('li');
      if (completedStatus[index]) li.classList.add('completed');
      li.setAttribute('data-index', index);

      const label = document.createElement('label');
      label.style = 'display: flex; align-items: flex-start; width: 100%;';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'task-checkbox';
      checkbox.checked = completedStatus[index];

      const checkmark = document.createElement('span');
      checkmark.className = 'checkmark';

      const span = document.createElement('span');
      span.className = 'task-text';
      span.textContent = task;

      label.appendChild(checkbox);
      label.appendChild(checkmark);
      label.appendChild(span);
      li.appendChild(label);
      taskList.appendChild(li);

      li.addEventListener('click', function (e) {
        const target = e.target;
        if (target === checkbox || target === checkmark || target === span) {
          const idx = parseInt(li.getAttribute('data-index'));
          const isChecked = checkbox.checked;

          checkbox.checked = !isChecked;
          completedStatus[idx] = !isChecked;
          li.classList.toggle('completed', !isChecked);
          localStorage.setItem('taskCompleted', JSON.stringify(completedStatus));
          updateSummary();
        }
      });

      checkbox.addEventListener('change', function () {
        const idx = parseInt(li.getAttribute('data-index'));
        completedStatus[idx] = this.checked;
        li.classList.toggle('completed', this.checked);
        localStorage.setItem('taskCompleted', JSON.stringify(completedStatus));
        updateSummary();
      });
    });

    // 全选 / 取消全选
    toggleAllBtn.addEventListener('click', () => {
      const isAllCompleted = completedStatus.every(status => status);
      const newStatus = !isAllCompleted;
      completedStatus = tasks.map(() => newStatus);

      document.querySelectorAll('#taskList li').forEach((li, index) => {
        const checkbox = li.querySelector('.task-checkbox');
        checkbox.checked = newStatus;
        li.classList.toggle('completed', newStatus);
      });

      localStorage.setItem('taskCompleted', JSON.stringify(completedStatus));
      updateSummary();
    });

    // 导出为 PDF
    exportPdfBtn.addEventListener('click', () => {
      const opt = {
        margin: 10,
        filename: '会议筹备清单.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().from(document.getElementById('exportArea')).set(opt).save();
    });

    // 生成二维码（✅ 修复：只生成一次）
    showQrCodeBtn.addEventListener('click', () => {
      qrcodeModal.style.display = 'flex';
      const qrcodeDiv = document.getElementById('qrcode');

      // 防止重复生成
      if (qrcodeDiv.querySelector('canvas') === null && qrcodeDiv.querySelector('img') === null) {
        const currentUrl = window.location.href;
        new QRCode(qrcodeDiv, {
          text: currentUrl,
          width: 200,
          height: 200,
          colorDark: "#000",
          colorLight: "#fff"
        });
      }
    });

    function closeQrCode() {
      qrcodeModal.style.display = 'none';
    }

    // 夜间模式切换
    themeToggleBtn.addEventListener('click', () => {
      const isNight = document.body.classList.toggle('night');
      themeToggleBtn.textContent = isNight ? '☀️ 日间模式' : '🌙 夜间模式';
      localStorage.setItem('nightMode', isNight);
    });

    // 恢复夜间模式
    if (localStorage.getItem('nightMode') === 'true') {
      document.body.classList.add('night');
      themeToggleBtn.textContent = '☀️ 日间模式';
    }

    updateSummary();
  </script>

</body>
</html>